# syntax=docker/dockerfile:1

FROM node:20 AS base
WORKDIR /workspace
RUN corepack enable && corepack prepare pnpm@10.18.0 --activate

FROM base AS deps
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY agent/package.json agent/package.json
RUN pnpm install --filter agent... --frozen-lockfile

FROM deps AS build
COPY tsconfig.base.json ./
COPY agent ./agent
RUN pnpm --filter agent build

FROM node:20 AS runner
WORKDIR /workspace
RUN corepack enable && corepack prepare pnpm@10.18.0 --activate
ENV NODE_ENV=production
ENV PORT=4001
COPY pnpm-workspace.yaml ./
COPY package.json ./
COPY agent/package.json ./agent/
COPY --from=deps /workspace/node_modules ./node_modules
COPY --from=deps /workspace/agent/node_modules ./agent/node_modules
COPY --from=build /workspace/agent/dist ./agent/dist

EXPOSE 4001
WORKDIR /workspace/agent
CMD ["node", "dist/index.js"]
